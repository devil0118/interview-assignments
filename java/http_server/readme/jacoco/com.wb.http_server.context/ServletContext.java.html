<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServletContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">HttpServer</a> &gt; <a href="index.source.html" class="el_package">com.wb.http_server.context</a> &gt; <span class="el_source">ServletContext.java</span></div><h1>ServletContext.java</h1><pre class="source lang-java linenums">package com.wb.http_server.context;

import com.wb.http_server.context.holder.FilterHolder;
import com.wb.http_server.context.holder.ServletHolder;
import com.wb.http_server.cookie.Cookie;
import com.wb.http_server.exception.FilterNotFoundException;
import com.wb.http_server.exception.ServletNotFoundException;
import com.wb.http_server.filter.Filter;
import com.wb.http_server.listener.RequestAndSessionListener;
import com.wb.http_server.listener.HttpSessionListener;
import com.wb.http_server.listener.ServletRequestListener;
import com.wb.http_server.listener.event.HttpSessionEvent;
import com.wb.http_server.listener.event.ServletRequestEvent;
import com.wb.http_server.request.Request;
import com.wb.http_server.response.Response;
import com.wb.http_server.servlet.Servlet;
import com.wb.http_server.session.HttpSession;
import com.wb.http_server.session.IdleSessionCleaner;
import com.wb.http_server.util.PathMatcher;
import com.wb.http_server.util.UUIDUtil;
import lombok.extern.slf4j.Slf4j;

import java.time.Duration;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

import static com.wb.http_server.constant.ContextConstant.*;

/**
 * @author bing.wang
 * @date 2021/1/15
 */

<span class="nc" id="L36">@Slf4j</span>
public class ServletContext {
    /**
     * 别名-&gt;类名
     * 一个Servlet类只能有一个Servlet别名，一个Servlet别名只能对应一个Servlet类
     */
    private Map&lt;String, ServletHolder&gt; servlets;
    /**
     * 一个Servlet可以对应多个URL，一个URL只能对应一个Servlet
     * URL Pattern -&gt; Servlet别名
     */
    private Map&lt;String, String&gt; servletMapping;


    /**
     * 监听器们
     */
    private List&lt;ServletRequestListener&gt; servletRequestListeners;
    private List&lt;HttpSessionListener&gt; httpSessionListeners;


    /**
     * 别名-&gt;类名
     */
    private Map&lt;String, FilterHolder&gt; filters;
    /**
     * URL Pattern -&gt; 别名列表，注意同一个URLPattern可以对应多个Filter，但只能对应一个Servlet
     */
    private Map&lt;String, List&lt;String&gt;&gt; filterMapping;

    /**
     * 整个应用对应的session们
     */
    private Map&lt;String, HttpSession&gt; sessions;
    private IdleSessionCleaner idleSessionCleaner;

    private PathMatcher matcher;


    /**
     * 域
     */
    private Map&lt;String, Object&gt; attributes;

<span class="nc" id="L80">    public ServletContext() {</span>
<span class="nc" id="L81">        init();</span>
<span class="nc" id="L82">    }</span>

    /**
     * 由URL得到对应的一个Servlet实例
     *
     * @param url
     * @return
     * @throws ServletNotFoundException
     */
    public Servlet mapServlet(String url) throws ServletNotFoundException {
        // 1、精确匹配

<span class="nc" id="L94">        String servletAlias = servletMapping.get(url);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (servletAlias != null) {</span>
<span class="nc" id="L96">            return initAndGetServlet(servletAlias);</span>
        }
        // 2、路径匹配
<span class="nc" id="L99">        List&lt;String&gt; matchingPatterns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L100">        Set&lt;String&gt; patterns = servletMapping.keySet();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        for (String pattern : patterns) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (matcher.match(pattern, url)) {</span>
<span class="nc" id="L103">                matchingPatterns.add(pattern);</span>
            }
<span class="nc" id="L105">        }</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (!matchingPatterns.isEmpty()) {</span>
<span class="nc" id="L108">            Comparator&lt;String&gt; patternComparator = matcher.getPatternComparator(url);</span>
<span class="nc" id="L109">            Collections.sort(matchingPatterns, patternComparator);</span>
<span class="nc" id="L110">            String bestMatch = matchingPatterns.get(0);</span>
<span class="nc" id="L111">            return initAndGetServlet(servletMapping.get(bestMatch));</span>
        }
<span class="nc" id="L113">        return initAndGetServlet(DEFAULT_SERVLET_ALIAS);</span>
    }

    /**
     * 由URL得到一系列匹配的Filter实例
     *
     * @param url
     * @return
     */
    public List&lt;Filter&gt; mapFilter(String url) throws FilterNotFoundException {
<span class="nc" id="L123">        List&lt;String&gt; matchingPatterns = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L124">        Set&lt;String&gt; patterns = filterMapping.keySet();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        for (String pattern : patterns) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (matcher.match(pattern, url)) {</span>
<span class="nc" id="L127">                matchingPatterns.add(pattern);</span>
            }
<span class="nc" id="L129">        }</span>

<span class="nc" id="L131">        Set&lt;String&gt; filterAliases = matchingPatterns.stream().flatMap(pattern -&gt; this.filterMapping.get(pattern).stream()).collect(Collectors.toSet());</span>
<span class="nc" id="L132">        List&lt;Filter&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        for (String alias : filterAliases) {</span>
<span class="nc" id="L134">            result.add(initAndGetFilter(alias));</span>
<span class="nc" id="L135">        }</span>
<span class="nc" id="L136">        return result;</span>
    }


    /**
     * 初始化并返回Filter实例，如果已经初始化过则直接返回
     *
     * @param filterAlias
     * @return
     * @throws FilterNotFoundException
     */
    private Filter initAndGetFilter(String filterAlias) throws FilterNotFoundException {
<span class="nc" id="L148">        FilterHolder filterHolder = filters.get(filterAlias);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (filterHolder == null) {</span>
<span class="nc" id="L150">            throw new FilterNotFoundException();</span>
        }
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (filterHolder.getFilter() == null) {</span>
            try {
<span class="nc" id="L154">                Filter filter = (Filter) Class.forName(filterHolder.getFilterClass()).newInstance();</span>
<span class="nc" id="L155">                filter.init();</span>
<span class="nc" id="L156">                filterHolder.setFilter(filter);</span>
<span class="nc" id="L157">            } catch (InstantiationException e) {</span>
<span class="nc" id="L158">                e.printStackTrace();</span>
<span class="nc" id="L159">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L160">                e.printStackTrace();</span>
<span class="nc" id="L161">            } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L162">                e.printStackTrace();</span>
<span class="nc" id="L163">            }</span>
        }
<span class="nc" id="L165">        return filterHolder.getFilter();</span>
    }

    /**
     * 初始化并获取Servlet实例，如果已经初始化过则直接返回
     *
     * @param servletAlias
     * @return
     * @throws ServletNotFoundException
     */
    private Servlet initAndGetServlet(String servletAlias) throws ServletNotFoundException {
<span class="nc" id="L176">        ServletHolder servletHolder = servlets.get(servletAlias);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (servletHolder == null) {</span>
<span class="nc" id="L178">            throw new ServletNotFoundException();</span>
        }
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (servletHolder.getServlet() == null) {</span>
            try {
<span class="nc" id="L182">                Servlet servlet = (Servlet) Class.forName(servletHolder.getServletClass()).newInstance();</span>
<span class="nc" id="L183">                servlet.init();</span>
<span class="nc" id="L184">                servletHolder.setServlet(servlet);</span>
<span class="nc" id="L185">            } catch (InstantiationException e) {</span>
<span class="nc" id="L186">                e.printStackTrace();</span>
<span class="nc" id="L187">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L188">                e.printStackTrace();</span>
<span class="nc" id="L189">            } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L190">                e.printStackTrace();</span>
<span class="nc" id="L191">            }</span>
        }
<span class="nc" id="L193">        return servletHolder.getServlet();</span>
    }


    /**
     * 应用初始化
     */
    private void init() {
<span class="nc" id="L201">        this.servlets = new HashMap&lt;&gt;();</span>
<span class="nc" id="L202">        this.servletMapping = new HashMap&lt;&gt;();</span>
<span class="nc" id="L203">        this.attributes = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L204">        this.filters = new HashMap&lt;&gt;();</span>
<span class="nc" id="L205">        this.filterMapping = new HashMap&lt;&gt;();</span>
<span class="nc" id="L206">        this.sessions = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L207">        this.idleSessionCleaner = new IdleSessionCleaner();</span>
<span class="nc" id="L208">        this.idleSessionCleaner.start();</span>
<span class="nc" id="L209">        this.servletRequestListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L210">        this.httpSessionListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L211">        this.matcher = new PathMatcher();</span>
<span class="nc" id="L212">        config();</span>

<span class="nc" id="L214">    }</span>

    /**
     * 应用关闭前被调用
     */
    public void destroy() {
<span class="nc" id="L220">        servlets.values().forEach(servletHolder -&gt; {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (servletHolder.getServlet() != null) {</span>
<span class="nc" id="L222">                servletHolder.getServlet().destroy();</span>
            }
<span class="nc" id="L224">        });</span>
<span class="nc" id="L225">        filters.values().forEach(filterHolder -&gt; {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (filterHolder.getFilter() != null) {</span>
<span class="nc" id="L227">                filterHolder.getFilter().destroy();</span>
            }
<span class="nc" id="L229">        });</span>
<span class="nc" id="L230">    }</span>

    public void addServlet(String servletName, String mapping,String servletClass){
<span class="nc" id="L233">        this.servlets.put(servletName,new ServletHolder(servletClass));</span>
<span class="nc" id="L234">        this.servletMapping.put(mapping,servletName);</span>
<span class="nc" id="L235">    }</span>

    private void config() {
<span class="nc" id="L238">        this.servlets.put(&quot;DefaultServlet&quot;, new ServletHolder(&quot;com.wb.http_server.servlet.impl.DefaultServlet&quot;));</span>
<span class="nc" id="L239">        this.servletMapping.put(&quot;/&quot;, &quot;DefaultServlet&quot;);</span>
<span class="nc" id="L240">        this.filters.put(&quot;LoginFilter&quot;, new FilterHolder(&quot;com.wb.http_server.filter.LoginFilter&quot;));</span>
<span class="nc" id="L241">        this.filterMapping.put(&quot;/**&quot;, Arrays.asList(&quot;LoginFilter&quot;));</span>
<span class="nc" id="L242">        servletRequestListeners.add(new RequestAndSessionListener());</span>
<span class="nc" id="L243">        httpSessionListeners.add(new RequestAndSessionListener());</span>
<span class="nc" id="L244">    }</span>


    /**
     * 获取session
     *
     * @param JSESSIONID
     * @return
     */
    public HttpSession getSession(String JSESSIONID) {
<span class="nc" id="L254">        return sessions.get(JSESSIONID);</span>
    }

    /**
     * 创建session
     *
     * @param response
     * @return
     */
    public HttpSession createSession(Response response) {
<span class="nc" id="L264">        HttpSession session = new HttpSession(UUIDUtil.uuid());</span>
<span class="nc" id="L265">        sessions.put(session.getId(), session);</span>
<span class="nc" id="L266">        response.addCookie(new Cookie(&quot;JSESSIONID&quot;, session.getId()));</span>
<span class="nc" id="L267">        HttpSessionEvent httpSessionEvent = new HttpSessionEvent(session);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (HttpSessionListener listener : httpSessionListeners) {</span>
<span class="nc" id="L269">            listener.sessionCreated(httpSessionEvent);</span>
<span class="nc" id="L270">        }</span>
<span class="nc" id="L271">        return session;</span>
    }

    /**
     * 销毁session
     *
     * @param session
     */
    public void invalidateSession(HttpSession session) {
<span class="nc" id="L280">        sessions.remove(session.getId());</span>
<span class="nc" id="L281">        afterSessionDestroyed(session);</span>
<span class="nc" id="L282">    }</span>

    /**
     * 清除空闲的session
     * 由于ConcurrentHashMap是线程安全的，所以remove不需要进行加锁
     */
    public void cleanIdleSessions() {
<span class="nc bnc" id="L289" title="All 2 branches missed.">        for (Iterator&lt;Map.Entry&lt;String, HttpSession&gt;&gt; it = sessions.entrySet().iterator(); it.hasNext(); ) {</span>
<span class="nc" id="L290">            Map.Entry&lt;String, HttpSession&gt; entry = it.next();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">            if (Duration.between(entry.getValue().getLastAccessed(), Instant.now()).getSeconds() &gt;= DEFAULT_SESSION_EXPIRE_TIME) {</span>
<span class="nc" id="L292">                log.info(&quot;该session {} 已过期&quot;, entry.getKey());</span>
<span class="nc" id="L293">                afterSessionDestroyed(entry.getValue());</span>
<span class="nc" id="L294">                it.remove();</span>
            }
<span class="nc" id="L296">        }</span>
<span class="nc" id="L297">    }</span>

    private void afterSessionDestroyed(HttpSession session) {
<span class="nc" id="L300">        HttpSessionEvent httpSessionEvent = new HttpSessionEvent(session);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">        for (HttpSessionListener listener : httpSessionListeners) {</span>
<span class="nc" id="L302">            listener.sessionDestroyed(httpSessionEvent);</span>
<span class="nc" id="L303">        }</span>
<span class="nc" id="L304">    }</span>

    public void afterRequestCreated(Request request) {
<span class="nc" id="L307">        ServletRequestEvent servletRequestEvent = new ServletRequestEvent(this, request);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        for (ServletRequestListener listener : servletRequestListeners) {</span>
<span class="nc" id="L309">            listener.requestInitialized(servletRequestEvent);</span>
<span class="nc" id="L310">        }</span>
<span class="nc" id="L311">    }</span>

    public void afterRequestDestroyed(Request request) {
<span class="nc" id="L314">        ServletRequestEvent servletRequestEvent = new ServletRequestEvent(this, request);</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        for (ServletRequestListener listener : servletRequestListeners) {</span>
<span class="nc" id="L316">            listener.requestDestroyed(servletRequestEvent);</span>
<span class="nc" id="L317">        }</span>
<span class="nc" id="L318">    }</span>

    public Object getAttribute(String key) {
<span class="nc" id="L321">        return attributes.get(key);</span>
    }

    public void setAttribute(String key, Object value) {
<span class="nc" id="L325">        attributes.put(key, value);</span>
<span class="nc" id="L326">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>